<!DOCTYPE html>
<html>
<head>
  <title>Test Auth State - LensRoom</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0F0F10;
      color: #fff;
    }
    .test-section {
      background: #1A1A1C;
      border: 1px solid #3A3A3C;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success { background: #00D9FF20; border-left: 4px solid #00D9FF; }
    .error { background: #FF000020; border-left: 4px solid #FF0000; }
    .warning { background: #FFA50020; border-left: 4px solid #FFA500; }
    button {
      background: #00D9FF;
      color: #0F0F10;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #00BFDD;
    }
    pre {
      background: #0F0F10;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç Test Auth State - LensRoom</h1>
  
  <div class="test-section">
    <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h2>
    <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
    <div id="localStorage-result"></div>
  </div>

  <div class="test-section">
    <h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Cookies</h2>
    <button onclick="checkCookies()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Cookies</button>
    <div id="cookies-result"></div>
  </div>

  <div class="test-section">
    <h2>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ API Session</h2>
    <button onclick="checkAPISession()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/auth/session</button>
    <div id="api-session-result"></div>
  </div>

  <div class="test-section">
    <h2>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Credits</h2>
    <button onclick="checkCredits()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/credits</button>
    <div id="credits-result"></div>
  </div>

  <script>
    function checkLocalStorage() {
      const result = document.getElementById('localStorage-result');
      result.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º...</p>';

      try {
        const lensroomUser = localStorage.getItem('lensroom-user');
        const supabaseAuth = localStorage.getItem('supabase.auth.token');
        
        let html = '';
        
        if (lensroomUser) {
          const user = JSON.parse(lensroomUser);
          html += `<div class="status success">
            <strong>‚úÖ lensroom-user –Ω–∞–π–¥–µ–Ω</strong>
            <pre>${JSON.stringify(user, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå lensroom-user –Ω–µ –Ω–∞–π–¥–µ–Ω</strong>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ localStorage</p>
          </div>`;
        }

        if (supabaseAuth) {
          html += `<div class="status success">
            <strong>‚úÖ Supabase auth –Ω–∞–π–¥–µ–Ω</strong>
          </div>`;
        } else {
          html += `<div class="status warning">
            <strong>‚ö†Ô∏è Supabase auth –Ω–µ –Ω–∞–π–¥–µ–Ω</strong>
          </div>`;
        }

        result.innerHTML = html;
      } catch (e) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${e.message}
        </div>`;
      }
    }

    function checkCookies() {
      const result = document.getElementById('cookies-result');
      result.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º...</p>';

      const cookies = document.cookie.split(';').map(c => c.trim());
      const lrSession = cookies.find(c => c.startsWith('lr_session='));
      
      let html = '';
      
      if (lrSession) {
        html += `<div class="status success">
          <strong>‚úÖ lr_session cookie –Ω–∞–π–¥–µ–Ω</strong>
          <pre>${lrSession.substring(0, 50)}...</pre>
        </div>`;
      } else {
        html += `<div class="status error">
          <strong>‚ùå lr_session cookie –Ω–µ –Ω–∞–π–¥–µ–Ω</strong>
          <p>Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</p>
        </div>`;
      }

      html += `<div class="status">
        <strong>–í—Å–µ cookies:</strong>
        <pre>${cookies.join('\n')}</pre>
      </div>`;

      result.innerHTML = html;
    }

    async function checkAPISession() {
      const result = document.getElementById('api-session-result');
      result.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º...</p>';

      try {
        const response = await fetch('https://lensroom.ru/api/auth/session', {
          credentials: 'include'
        });
        const data = await response.json();

        let html = '';
        
        if (data.user) {
          html += `<div class="status success">
            <strong>‚úÖ –°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞</strong>
            <pre>${JSON.stringify(data.user, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå –°–µ—Å—Å–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</strong>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>`;
        }

        result.innerHTML = html;
      } catch (e) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong> ${e.message}
        </div>`;
      }
    }

    async function checkCredits() {
      const result = document.getElementById('credits-result');
      result.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º...</p>';

      try {
        const response = await fetch('https://lensroom.ru/api/credits', {
          credentials: 'include'
        });
        const data = await response.json();

        let html = '';
        
        if (response.ok && data.balance !== undefined) {
          html += `<div class="status success">
            <strong>‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–µ–Ω</strong>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å</strong>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>`;
        }

        result.innerHTML = html;
      } catch (e) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong> ${e.message}
        </div>`;
      }
    }

    // Auto-run checks on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        checkLocalStorage();
        checkCookies();
      }, 500);
    });
  </script>
</body>
</html>
