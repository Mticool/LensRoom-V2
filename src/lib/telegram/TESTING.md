# Тестирование Telegram бота LensRoom

## Обзор архитектуры

```
src/lib/telegram/
├── bot-client.ts       # API клиент для Telegram
├── bot-models.ts       # Конфигурация моделей
├── state/
│   └── user-state.ts   # Persistent state (Supabase)
├── handlers/
│   ├── messages.ts     # Обработка сообщений
│   ├── callbacks.ts    # Обработка кнопок
│   └── auth.ts         # Авторизация
├── menus/
│   ├── main-menu.ts    # Главное меню
│   ├── photo-menu.ts   # Генерация фото
│   ├── video-menu.ts   # Генерация видео
│   ├── balance-menu.ts # Баланс и платежи
│   └── audio-menu.ts   # TTS/Audio
└── flows/
    ├── photo-generation.ts  # Генерация фото
    └── video-generation.ts  # Генерация видео
```

---

## Тест 1: Базовые команды

### /start
- [ ] Открывается главное меню
- [ ] Показывается приветствие с именем
- [ ] Показывается баланс
- [ ] Отображаются все кнопки (Фото, Видео, Аудио, Библиотека, Баланс, Настройки)
- [ ] Если новый пользователь - создаётся профиль + начисляется 50⭐

### /help
- [ ] Показывается список команд

### /balance или /b
- [ ] Показывается баланс с разбивкой (подписка/пакеты)
- [ ] Кнопка "Пополнить"

### /app
- [ ] Открывается Mini App кнопка

---

## Тест 2: Генерация фото (T2I - текст в изображение)

### Выбор модели (/photo)
- [ ] Показывается список моделей с ценами
- [ ] Каждая модель кликабельна

### Конфигурация модели
- [ ] После выбора модели показываются настройки
- [ ] Можно менять качество (Turbo/Balanced/Quality)
- [ ] Можно менять формат (1:1, 16:9, 9:16)
- [ ] Отображается текущая цена

### Генерация
- [ ] Отправка текстового промпта запускает генерацию
- [ ] Показывается статус "Генерирую..."
- [ ] После завершения отправляется фото
- [ ] Показываются кнопки: "Ещё раз", "В избранное", "Новая генерация"
- [ ] Списываются звёзды

---

## Тест 3: Генерация фото (I2I - референс первый) ⭐ НОВЫЙ FLOW

### Загрузка референса БЕЗ команды
- [ ] Отправка фото показывает меню "Что хотите сделать?"
- [ ] Кнопки: "Фото I2I" и "Видео I2V"
- [ ] Кнопка "Отмена"

### Выбор "Фото I2I"
- [ ] Показывается список моделей
- [ ] Отмечено что референс загружен

### Выбор модели
- [ ] Показывается сообщение что референс загружен
- [ ] Запрашивается промпт
- [ ] Кнопка "Настройки" для изменения качества/формата

### Настройки (опционально)
- [ ] Можно менять качество
- [ ] Можно менять формат
- [ ] Кнопка "Готово - жду промпт"

### Генерация
- [ ] Отправка промпта запускает генерацию
- [ ] Используется загруженный референс
- [ ] Показывается результат

### Замена референса
- [ ] Если отправить новое фото во время ожидания промпта
- [ ] Референс обновляется
- [ ] Показывается подтверждение

---

## Тест 4: Генерация видео (T2V)

### Выбор модели (/video)
- [ ] Показывается список моделей с ценами
- [ ] Каждая модель кликабельна

### Конфигурация
- [ ] Можно менять длительность (5s, 10s)
- [ ] Можно менять формат
- [ ] Можно вкл/выкл звук (если поддерживается)

### Генерация
- [ ] Отправка промпта запускает генерацию
- [ ] Показывается статус с обновлениями
- [ ] После завершения отправляется видео
- [ ] Показываются кнопки действий

---

## Тест 5: Генерация видео (I2V - референс первый) ⭐ НОВЫЙ FLOW

### Загрузка стартового кадра
- [ ] Отправка фото → Выбор "Видео I2V"
- [ ] Показывается список видео моделей
- [ ] Отмечено что стартовый кадр загружен

### Выбор модели и настройки
- [ ] Настройки длительности
- [ ] Настройки формата
- [ ] Настройки звука

### Генерация
- [ ] Отправка промпта запускает генерацию
- [ ] Используется стартовый кадр
- [ ] Показывается результат

---

## Тест 6: Баланс и платежи

### Просмотр баланса
- [ ] /balance показывает текущий баланс
- [ ] Разбивка: подписка vs пакеты

### Меню оплаты
- [ ] Кнопка "Пополнить" открывает варианты
- [ ] Показываются подписки с ценами
- [ ] Показываются пакеты звёзд с ценами

### Процесс оплаты
- [ ] Выбор варианта генерирует ссылку
- [ ] Ссылка ведёт на сайт с правильным paymentId

---

## Тест 7: Аудио (TTS)

### Меню аудио (/audio)
- [ ] Показываются варианты: TTS, Клонирование, Музыка

### TTS меню
- [ ] Показывается список голосов
- [ ] Можно выбрать голос

---

## Тест 8: Quick Generation

### Быстрая генерация текстом
- [ ] Отправка текста БЕЗ команды (если нет активного flow)
- [ ] Запускается генерация с моделью по умолчанию (nano-banana)
- [ ] Показывается результат

---

## Тест 9: Edge Cases

### Недостаточно звёзд
- [ ] При попытке генерации показывается ошибка
- [ ] Предлагается пополнить баланс

### Отмена flow
- [ ] Кнопка "Отмена" очищает состояние
- [ ] Можно начать новый flow

### Ошибка генерации
- [ ] Показывается понятное сообщение об ошибке
- [ ] Flow очищается

### Таймаут flow (15 минут для референсов)
- [ ] После таймаута flow автоматически очищается
- [ ] Можно начать заново

---

## Тест 10: State Persistence

### Перезапуск сервера
- [ ] После рестарта сервера состояние сохраняется
- [ ] Активный flow продолжает работать
- [ ] Настройки пользователя сохраняются

---

## Команды для тестирования

```bash
# Проверить webhook
curl https://lensroom.ru/api/telegram/webhook?action=info

# Настроить webhook
curl https://lensroom.ru/api/telegram/webhook?action=setup

# Проверить логи
# Vercel Dashboard → lensroom-v2 → Logs
```

---

## Flow диаграмма: Референс первый

```
Пользователь отправляет фото
         │
         ▼
   ┌─────────────────┐
   │ Что хотите      │
   │ сделать?        │
   ├─────────────────┤
   │ [Фото I2I]      │
   │ [Видео I2V]     │
   │ [Отмена]        │
   └────────┬────────┘
            │
     ┌──────┴───────┐
     ▼              ▼
 Фото I2I      Видео I2V
     │              │
     ▼              ▼
 Выбор модели  Выбор модели
     │              │
     ▼              ▼
 [Настройки]   [Настройки]
     │              │
     ▼              ▼
 Жду промпт    Жду промпт
     │              │
     ▼              ▼
 Генерация     Генерация
     │              │
     ▼              ▼
 Результат     Результат
```

---

## Контрольный список перед продакшеном

- [ ] Все команды работают
- [ ] Референс-первый flow работает
- [ ] Генерация фото работает
- [ ] Генерация видео работает
- [ ] Баланс отображается корректно
- [ ] Платежи работают
- [ ] Ошибки обрабатываются
- [ ] State сохраняется в Supabase
- [ ] Webhook настроен с секретным токеном
