# –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ (Affiliate Commissions)

## ‚úÖ –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è **–ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç –ø—Ä–æ–¥–∞–∂** –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º –≤ —Ä—É–±–ª—è—Ö —Å —Ä—É—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç–æ–π –∞–¥–º–∏–Ω–æ–º.

---

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

–ü–æ–ª—É—á–∞—é—Ç **—Ñ–∏–∫—Å-–±–æ–Ω—É—Å—ã –≤ –∑–≤—ë–∑–¥–∞—Ö ‚≠ê** –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π:
- üë§ Signup: +50‚≠ê —Ä–µ—Ñ–µ—Ä–µ—Ä—É, +25‚≠ê –Ω–æ–≤–æ–º—É
- üé® First generation: +100‚≠ê —Ä–µ—Ñ–µ—Ä–µ—Ä—É

**–î–ª—è –Ω–∏—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**

---

### 2. –ü–∞—Ä—Ç–Ω—ë—Ä—ã (Affiliates)

–ü–æ–ª—É—á–∞—é—Ç **–¢–û–õ–¨–ö–û % –æ—Ç –ø—Ä–æ–¥–∞–∂** –≤ —Ä—É–±–ª—è—Ö (–ë–ï–ó –∑–≤—ë–∑–¥ ‚≠ê):

#### –ü—Ä–æ—Ü–µ—Å—Å:

```
1. –ü–∞—Ä—Ç–Ω—ë—Ä –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ—Ñ. —Å—Å—ã–ª–∫–∞)
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –∑–∞ 1000‚ÇΩ
3. Robokassa webhook ‚Üí /api/webhooks/robokassa
4. –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ referrer? –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º?
5. –ù–∞—á–∏—Å–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏—é:
   - Classic (30%): 300‚ÇΩ
   - Pro (50%): 500‚ÇΩ
6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ affiliate_earnings (status=pending)
7. –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤ UI, –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –¥–µ–Ω—å–≥–∏ –≤—Ä—É—á–Ω—É—é
8. –ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É" ‚Üí status=paid
```

---

## üìÅ –§–∞–π–ª—ã

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
- `supabase/migrations/024_affiliate_earnings.sql`

**–¢–∞–±–ª–∏—Ü–∞ `affiliate_earnings`:**
- `affiliate_user_id` - –∫—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é (–ø–∞—Ä—Ç–Ω—ë—Ä)
- `referral_user_id` - –∫—Ç–æ –∫—É–ø–∏–ª (—Ä–µ—Ñ–µ—Ä–∞–ª)
- `payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ Robokassa
- `amount_rub` - —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏
- `commission_percent` - –ø—Ä–æ—Ü–µ–Ω—Ç (30 –∏–ª–∏ 50)
- `commission_rub` - –Ω–∞—á–∏—Å–ª–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
- `status` - pending / paid / cancelled
- `paid_at`, `paid_by`, `notes` - –∏–Ω—Ñ–æ –æ –≤—ã–ø–ª–∞—Ç–µ

**View `affiliate_earnings_summary`:**
- –°–≤–æ–¥–∫–∞ –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º: –ø—Ä–æ–¥–∞–∂–∏, –∫–æ–º–∏—Å—Å–∏–∏, –∫ –≤—ã–ø–ª–∞—Ç–µ, –≤—ã–ø–ª–∞—á–µ–Ω–æ

### Backend

**Helper:**
- `src/lib/referrals/process-affiliate-commission.ts`
  - `processAffiliateCommission()` - —Ä–∞—Å—á—ë—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏

**Webhook:**
- `src/app/api/webhooks/robokassa/route.ts`
  - POST endpoint –¥–ª—è Robokassa
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `processAffiliateCommission()`

**Admin API:**
- `src/app/api/admin/affiliate/earnings/route.ts`
  - GET - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∏—Å—Å–∏–π (+ —Ñ–∏–ª—å—Ç—Ä—ã)
  - POST - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É

### Frontend

**Admin UI:**
- `src/app/admin/affiliate-earnings/page.tsx`
  - –°–≤–æ–¥–∫–∞ –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º (–ø—Ä–æ–¥–∞–∂–∏, –∫ –≤—ã–ø–ª–∞—Ç–µ, –≤—ã–ø–ª–∞—á–µ–Ω–æ)
  - –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
  - –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É"

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Robokassa (TODO)

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Robokassa

**Result URL:**
```
https://lensroom.ru/api/webhooks/robokassa
Method: POST
```

**–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `Shp_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `Shp_tariff` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–í `.env.local`:
```bash
ROBOKASSA_PASSWORD_1=xxx  # –ü–∞—Ä–æ–ª—å #1 (–¥–ª—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã)
ROBOKASSA_PASSWORD_2=xxx  # –ü–∞—Ä–æ–ª—å #2 (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
ROBOKASSA_MERCHANT_LOGIN=xxx
```

### –®–∞–≥ 3: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏

–í `src/app/api/webhooks/robokassa/route.ts`:

```typescript
// TODO: –£–±—Ä–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞:
const merchantPass2 = process.env.ROBOKASSA_PASSWORD_2;
const mySignature = crypto
  .createHash('md5')
  .update(`${outSum}:${invId}:${merchantPass2}:Shp_user_id=${shpUserId}`)
  .digest('hex')
  .toUpperCase();

if (mySignature !== signatureValue) {
  console.error('[Robokassa Webhook] Invalid signature');
  return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
}
```

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ –≤ Robokassa (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏: `[Robokassa Webhook] Received:...`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `affiliate_earnings`: –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å
4. –û—Ç–∫—Ä–æ–π—Ç–µ `/admin/affiliate-earnings` - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–º–∏—Å—Å–∏—è

---

## üìä Admin UI

**–ü—É—Ç—å:** `/admin/affiliate-earnings`

**–ß—Ç–æ –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω:**

### 1. –°–≤–æ–¥–∫–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏):
- –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂: XXX‚ÇΩ
- –ö –≤—ã–ø–ª–∞—Ç–µ: XXX‚ÇΩ (pending)
- –í—ã–ø–ª–∞—á–µ–Ω–æ: XXX‚ÇΩ (paid)

### 2. –¢–∞–±–ª–∏—Ü–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤:
```
–ü–∞—Ä—Ç–Ω—ë—Ä | Tier | –ü—Ä–æ–¥–∞–∂ | –°—É–º–º–∞ | –ö –≤—ã–ø–ª–∞—Ç–µ | –í—ã–ø–ª–∞—á–µ–Ω–æ
----------------------------------------
–ò–≤–∞–Ω    | Pro  | 5      | 5000‚ÇΩ | 2500‚ÇΩ     | 0‚ÇΩ
–ú–∞—Ä–∏—è   | Clas | 3      | 3000‚ÇΩ | 900‚ÇΩ      | 0‚ÇΩ
```

### 3. –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```
[–ö –≤—ã–ø–ª–∞—Ç–µ] –ò–≤–∞–Ω ‚Üí –ü—ë—Ç—Ä
–¢–∞—Ä–∏—Ñ Pro
2024-12-20 ‚Ä¢ 1000‚ÇΩ ‚Ä¢ 50%
[500‚ÇΩ] [–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É]
```

**Workflow:**
1. –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç "–ö –≤—ã–ø–ª–∞—Ç–µ: 500‚ÇΩ"
2. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –¥–µ–Ω—å–≥–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—É (–≤–Ω–µ —Å–∏—Å—Ç–µ–º—ã)
3. –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É"
4. Status ‚Üí paid, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–∞—Ç–∞ –∏ –∫—Ç–æ –≤—ã–ø–ª–∞—Ç–∏–ª

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ö–æ–º–∏—Å—Å–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ server-side
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `payment_id` (–¥—É–±–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Robokassa (–∫–æ–≥–¥–∞ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ)
- ‚úÖ RLS policies: –ø–∞—Ä—Ç–Ω—ë—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∫–æ–º–∏—Å—Å–∏–∏
- ‚úÖ Admin-only –¥–æ—Å—Ç—É–ø –∫ –≤—ã–ø–ª–∞—Ç–∞–º

---

## üí∞ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á—ë—Ç–∞

### Classic (30%)

```
–ü–æ–∫—É–ø–∫–∞: 1000‚ÇΩ
–ö–æ–º–∏—Å—Å–∏—è: 1000 * 30 / 100 = 300‚ÇΩ
```

### Pro (50%)

```
–ü–æ–∫—É–ø–∫–∞: 5000‚ÇΩ
–ö–æ–º–∏—Å—Å–∏—è: 5000 * 50 / 100 = 2500‚ÇΩ
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ó–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

```sql
-- –¢–æ–ø-–ø–∞—Ä—Ç–Ω—ë—Ä—ã –ø–æ –∑–∞—Ä–∞–±–æ—Ç–∫—É
SELECT * FROM affiliate_earnings_summary
ORDER BY total_commission_rub DESC
LIMIT 10;

-- –ù–µ–≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏
SELECT SUM(commission_rub) as pending_total
FROM affiliate_earnings
WHERE status = 'pending';

-- –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç –∑–∞ –º–µ—Å—è—Ü
SELECT 
  DATE(paid_at) as date,
  COUNT(*) as payouts,
  SUM(commission_rub) as total
FROM affiliate_earnings
WHERE status = 'paid'
  AND paid_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(paid_at)
ORDER BY date DESC;
```

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Backend –ª–æ–≥–∏–∫–∞
- ‚úÖ Admin UI
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è: –ø–æ–¥–∫–ª—é—á–∏—Ç—å Robokassa (env + —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É)

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Robokassa —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
