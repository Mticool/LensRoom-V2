#!/usr/bin/env node
/**
 * Rebuild video posters (static thumbnails) for recent video generations.
 *
 * Why:
 * - Some providers (Veo/Sora) often start with a black fade.
 * - Older poster extraction used a fixed timestamp (1s) which can produce black thumbnails.
 * - This script clears poster_path and re-queues poster generation using the previews worker/endpoint.
 *
 * Usage:
 *   node scripts/rebuild-video-posters.js --limit=200
 *   node scripts/rebuild-video-posters.js --limit=200 --dry-run
 *
 * Env required:
 *   NEXT_PUBLIC_SUPABASE_URL
 *   SUPABASE_SERVICE_ROLE_KEY
 */

const { createClient } = require("@supabase/supabase-js");
const path = require("path");
const fs = require("fs");

// Load environment from .env.local if exists
const envPath = path.join(__dirname, "..", ".env.local");
if (fs.existsSync(envPath)) {
  const envContent = fs.readFileSync(envPath, "utf8");
  envContent.split("\n").forEach((line) => {
    const match = line.match(/^([^#=]+)=(.*)$/);
    if (match && !process.env[match[1]]) {
      process.env[match[1]] = match[2].replace(/^["']|["']$/g, "");
    }
  });
}

const args = process.argv.slice(2);
const getArg = (name, def) => {
  const a = args.find((x) => x.startsWith(`--${name}=`));
  return a ? a.split("=", 2)[1] : def;
};
const hasFlag = (name) => args.includes(`--${name}`);

const LIMIT = parseInt(getArg("limit", "200"), 10);
const DRY_RUN = hasFlag("dry-run");
const KEEP_FILES = hasFlag("keep-files");

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error("❌ Missing env vars: NEXT_PUBLIC_SUPABASE_URL and/or SUPABASE_SERVICE_ROLE_KEY");
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

async function main() {
  console.log("═══════════════════════════════════════════════════");
  console.log("   REBUILD VIDEO POSTERS");
  console.log("═══════════════════════════════════════════════════");
  console.log(`   Supabase URL: ${SUPABASE_URL}`);
  console.log(`   Limit: ${LIMIT}`);
  console.log(`   Dry run: ${DRY_RUN}`);
  console.log(`   Keep old files: ${KEEP_FILES}`);
  console.log("═══════════════════════════════════════════════════\n");

  const { data: rows, error } = await supabase
    .from("generations")
    .select("id,type,status,created_at,poster_path,preview_status")
    .eq("type", "video")
    .in("status", ["success", "completed", "succeeded"])
    .order("created_at", { ascending: false })
    .limit(LIMIT);

  if (error) throw new Error(`Fetch failed: ${error.message}`);

  const list = Array.isArray(rows) ? rows : [];
  console.log(`Found ${list.length} recent video generations.`);

  if (DRY_RUN) {
    const withPoster = list.filter((r) => !!r.poster_path).length;
    const withoutPoster = list.filter((r) => !r.poster_path).length;
    console.log(`Dry run: with poster_path=${withPoster}, missing poster_path=${withoutPoster}`);
    return;
  }

  let updated = 0;
  let removed = 0;
  let removeFailed = 0;

  for (const r of list) {
    const id = String(r.id || "").trim();
    if (!id) continue;

    const posterPath = r.poster_path ? String(r.poster_path) : "";
    if (posterPath && !KEEP_FILES) {
      try {
        const { error: rmErr } = await supabase.storage.from("generations").remove([posterPath]);
        if (!rmErr) removed++;
        else removeFailed++;
      } catch {
        removeFailed++;
      }
    }

    const { error: upErr } = await supabase
      .from("generations")
      .update({
        poster_path: null,
        preview_status: "none",
        updated_at: new Date().toISOString(),
      })
      .eq("id", id);

    if (upErr) {
      console.error(`❌ Update failed id=${id}: ${upErr.message}`);
      continue;
    }

    updated++;
    process.stdout.write(`\rRequeued: ${updated}/${list.length} (removed=${removed}, rm_failed=${removeFailed})`);
  }

  console.log("\n✅ Done. Posters will be regenerated by the previews worker / auto-scheduler.");
  console.log("Tip: watch PM2 logs: pm2 logs lensroom-previews-worker --lines 200");
}

main().catch((e) => {
  console.error("❌ Fatal:", e?.message || e);
  process.exit(1);
});

