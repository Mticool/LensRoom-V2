<!DOCTYPE html>
<html>
<head>
  <title>üîç Test Live Auth - LensRoom</title>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0F0F10;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00D9FF, #CDFF00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      color: #A1A1AA;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      background: #1A1A1C;
      border: 1px solid #3A3A3C;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status {
      padding: 16px;
      border-radius: 8px;
      margin: 12px 0;
      border-left: 4px solid;
    }
    .status.success {
      background: rgba(0, 217, 255, 0.1);
      border-color: #00D9FF;
    }
    .status.error {
      background: rgba(255, 0, 0, 0.1);
      border-color: #FF0000;
    }
    .status.warning {
      background: rgba(255, 165, 0, 0.1);
      border-color: #FFA500;
    }
    .status.info {
      background: rgba(205, 255, 0, 0.1);
      border-color: #CDFF00;
    }
    .status strong {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .status pre {
      background: #0F0F10;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
      margin-top: 8px;
    }
    button {
      background: #00D9FF;
      color: #0F0F10;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    button:hover {
      background: #00BFDD;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #3A3A3C;
      color: #6B6B6E;
      cursor: not-allowed;
      transform: none;
    }
    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #3A3A3C;
      border-top-color: #00D9FF;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      background: #CDFF00;
      color: #0F0F10;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .summary-card {
      background: #0F0F10;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .summary-card .value {
      font-size: 32px;
      font-weight: 700;
      margin: 8px 0;
    }
    .summary-card .label {
      font-size: 12px;
      color: #A1A1AA;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Live Auth Check</h1>
    <p class="subtitle">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ lensroom.ru –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>

    <!-- Summary Dashboard -->
    <div class="section">
      <h2>üìä –°—Ç–∞—Ç—É—Å</h2>
      <div class="summary" id="summary">
        <div class="summary-card">
          <div class="label">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
          <div class="value" id="auth-status">‚è≥</div>
        </div>
        <div class="summary-card">
          <div class="label">–ë–∞–ª–∞–Ω—Å</div>
          <div class="value" id="balance-status">‚è≥</div>
        </div>
        <div class="summary-card">
          <div class="label">–ö–Ω–æ–ø–∫–∞ Generate</div>
          <div class="value" id="button-status">‚è≥</div>
        </div>
      </div>
    </div>

    <!-- Test 1: Auth Check -->
    <div class="section">
      <h2>üîê 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
      <div class="button-group">
        <button onclick="checkAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/auth/me</button>
        <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <button onclick="checkCookies()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Cookies</button>
      </div>
      <div id="auth-result"></div>
    </div>

    <!-- Test 2: Credits Check -->
    <div class="section">
      <h2>üí∞ 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–∞–ª–∞–Ω—Å–∞</h2>
      <div class="button-group">
        <button onclick="checkCredits()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/credits/balance</button>
      </div>
      <div id="credits-result"></div>
    </div>

    <!-- Test 3: Generate Button Logic -->
    <div class="section">
      <h2>üé® 3. –õ–æ–≥–∏–∫–∞ –ö–Ω–æ–ø–∫–∏ Generate</h2>
      <div class="button-group">
        <button onclick="checkGenerateButton()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –£—Å–ª–æ–≤–∏—è</button>
      </div>
      <div id="button-result"></div>
    </div>

    <!-- Test 4: Fix Actions -->
    <div class="section">
      <h2>üîß 4. –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
      <div id="fix-actions"></div>
    </div>
  </div>

  <script>
    let authData = null;
    let creditsData = null;

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        runAllTests();
      }, 500);
    });

    async function runAllTests() {
      await checkAuth();
      await checkCredits();
      await checkGenerateButton();
      updateSummary();
    }

    function updateSummary() {
      const authStatus = document.getElementById('auth-status');
      const balanceStatus = document.getElementById('balance-status');
      const buttonStatus = document.getElementById('button-status');

      // Auth Status
      if (authData && (authData.user || authData.telegramId)) {
        authStatus.textContent = '‚úÖ';
        authStatus.style.color = '#00D9FF';
      } else {
        authStatus.textContent = '‚ùå';
        authStatus.style.color = '#FF0000';
      }

      // Balance Status
      if (creditsData && creditsData.balance > 0) {
        balanceStatus.textContent = creditsData.balance + '‚≠ê';
        balanceStatus.style.color = '#CDFF00';
      } else {
        balanceStatus.textContent = '0‚≠ê';
        balanceStatus.style.color = '#FF0000';
      }

      // Button Status
      const isAuthenticated = authData && (authData.user || authData.telegramId);
      const hasCredits = creditsData && creditsData.balance >= 30;
      const canGenerate = isAuthenticated && hasCredits;

      if (canGenerate) {
        buttonStatus.textContent = '‚úÖ';
        buttonStatus.style.color = '#00D9FF';
      } else {
        buttonStatus.textContent = '‚ùå';
        buttonStatus.style.color = '#FF0000';
      }
    }

    async function checkAuth() {
      const result = document.getElementById('auth-result');
      result.innerHTML = '<div class="status info"><span class="loading"></span> –ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>';

      try {
        const response = await fetch('https://lensroom.ru/api/auth/me', {
          credentials: 'include'
        });
        authData = await response.json();

        let html = '';

        if (response.ok && (authData.user || authData.telegramId)) {
          html += `<div class="status success">
            <strong>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è OK</strong>
            <pre>${JSON.stringify(authData, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</strong>
            <p>–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª: <code>${response.status} ${response.statusText}</code></p>
            <pre>${JSON.stringify(authData, null, 2)}</pre>
          </div>`;
        }

        result.innerHTML = html;
      } catch (error) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</strong>
          <p>${error.message}</p>
        </div>`;
      }

      updateSummary();
    }

    function checkLocalStorage() {
      const result = document.getElementById('auth-result');
      
      try {
        const lensroomUser = localStorage.getItem('lensroom-user');
        
        let html = '';
        
        if (lensroomUser) {
          const user = JSON.parse(lensroomUser);
          html += `<div class="status success">
            <strong>‚úÖ localStorage –Ω–∞–π–¥–µ–Ω</strong>
            <pre>${JSON.stringify(user, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå localStorage –ø—É—Å—Ç</strong>
            <p>–ö–ª—é—á 'lensroom-user' –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
          </div>`;
        }

        result.innerHTML = html;
      } catch (error) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}
        </div>`;
      }
    }

    function checkCookies() {
      const result = document.getElementById('auth-result');
      
      const cookies = document.cookie.split(';').map(c => c.trim());
      const lrSession = cookies.find(c => c.startsWith('lr_session='));
      
      let html = '';
      
      if (lrSession) {
        html += `<div class="status success">
          <strong>‚úÖ Cookie lr_session –Ω–∞–π–¥–µ–Ω</strong>
          <pre>${lrSession.substring(0, 100)}...</pre>
        </div>`;
      } else {
        html += `<div class="status error">
          <strong>‚ùå Cookie lr_session –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</strong>
          <p>Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</p>
          <p><strong>–í—Å–µ cookies:</strong></p>
          <pre>${cookies.join('\n')}</pre>
        </div>`;
      }

      result.innerHTML = html;
    }

    async function checkCredits() {
      const result = document.getElementById('credits-result');
      result.innerHTML = '<div class="status info"><span class="loading"></span> –ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>';

      try {
        const response = await fetch('https://lensroom.ru/api/credits/balance', {
          credentials: 'include'
        });
        creditsData = await response.json();

        let html = '';

        if (response.ok && creditsData.balance !== undefined) {
          const balance = creditsData.balance;
          const statusClass = balance >= 30 ? 'success' : (balance > 0 ? 'warning' : 'error');
          const icon = balance >= 30 ? '‚úÖ' : (balance > 0 ? '‚ö†Ô∏è' : '‚ùå');
          
          html += `<div class="status ${statusClass}">
            <strong>${icon} –ë–∞–ª–∞–Ω—Å: ${balance}‚≠ê</strong>
            <p>–ú–∏–Ω–∏–º—É–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 30‚≠ê (1K –∫–∞—á–µ—Å—Ç–≤–æ)</p>
            <pre>${JSON.stringify(creditsData, null, 2)}</pre>
          </div>`;
        } else {
          html += `<div class="status error">
            <strong>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å</strong>
            <p>–û—Ç–≤–µ—Ç: <code>${response.status} ${response.statusText}</code></p>
            <pre>${JSON.stringify(creditsData, null, 2)}</pre>
          </div>`;
        }

        result.innerHTML = html;
      } catch (error) {
        result.innerHTML = `<div class="status error">
          <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong> ${error.message}
        </div>`;
      }

      updateSummary();
    }

    function checkGenerateButton() {
      const result = document.getElementById('button-result');
      const fixActions = document.getElementById('fix-actions');

      const isAuthenticated = authData && (authData.user || authData.telegramId);
      const hasCredits = creditsData && creditsData.balance >= 30;
      const balance = creditsData?.balance || 0;

      let html = '<div class="status info"><strong>üìã –£—Å–ª–æ–≤–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ Generate:</strong></div>';

      // Check 1: Authentication
      if (isAuthenticated) {
        html += `<div class="status success">
          <strong>‚úÖ 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: OK</strong>
          <p>isAuthenticated = true</p>
        </div>`;
      } else {
        html += `<div class="status error">
          <strong>‚ùå 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: FAILED</strong>
          <p>isAuthenticated = false</p>
          <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> /api/auth/me –Ω–µ –≤–µ—Ä–Ω—É–ª user</p>
        </div>`;
      }

      // Check 2: Credits
      if (hasCredits) {
        html += `<div class="status success">
          <strong>‚úÖ 2. –ë–∞–ª–∞–Ω—Å: OK</strong>
          <p>credits (${balance}‚≠ê) >= estimatedCost (30‚≠ê)</p>
        </div>`;
      } else {
        html += `<div class="status error">
          <strong>‚ùå 2. –ë–∞–ª–∞–Ω—Å: FAILED</strong>
          <p>credits (${balance}‚≠ê) < estimatedCost (30‚≠ê)</p>
          <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤</p>
        </div>`;
      }

      // Check 3: Prompt (assumed OK)
      html += `<div class="status success">
        <strong>‚úÖ 3. –ü—Ä–æ–º–ø—Ç: OK</strong>
        <p>prompt.trim().length > 0 (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–º)</p>
      </div>`;

      // Final result
      const canGenerate = isAuthenticated && hasCredits;
      
      if (canGenerate) {
        html += `<div class="status success">
          <strong>üéâ –†–ï–ó–£–õ–¨–¢–ê–¢: –ö–Ω–æ–ø–∫–∞ Generate –ê–ö–¢–ò–í–ù–ê</strong>
          <p>–í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</p>
        </div>`;

        fixActions.innerHTML = `<div class="status success">
          <strong>‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong>
          <p>–ö–Ω–æ–ø–∫–∞ Generate –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–µ–ª—ë–Ω–æ–π –∏ –∞–∫—Ç–∏–≤–Ω–æ–π.</p>
          <p>–ï—Å–ª–∏ –æ–Ω–∞ –≤—Å—ë –µ—â—ë –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞:</p>
          <ol style="margin-left: 20px; margin-top: 10px;">
            <li>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+R)</li>
            <li>–û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à (Ctrl+Shift+R)</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–º–ø—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–º)</li>
          </ol>
        </div>`;
      } else {
        html += `<div class="status error">
          <strong>‚ùå –†–ï–ó–£–õ–¨–¢–ê–¢: –ö–Ω–æ–ø–∫–∞ Generate –ù–ï–ê–ö–¢–ò–í–ù–ê</strong>
          <p>–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –≤—ã—à–µ ‚òùÔ∏è</p>
        </div>`;

        // Fix actions
        let fixHtml = '';
        if (!isAuthenticated) {
          fixHtml += `<div class="status error">
            <strong>üîß –î–µ–π—Å—Ç–≤–∏–µ 1: –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å</strong>
            <ol style="margin-left: 20px; margin-top: 10px;">
              <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://lensroom.ru" style="color: #00D9FF;">https://lensroom.ru</a></li>
              <li>–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"</li>
              <li>–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Telegram</li>
              <li>–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç</li>
            </ol>
          </div>`;
        }

        if (!hasCredits) {
          fixHtml += `<div class="status warning">
            <strong>üîß –î–µ–π—Å—Ç–≤–∏–µ 2: –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å</strong>
            <p>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balance}‚≠ê</p>
            <p>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ: 30‚≠ê (–º–∏–Ω–∏–º—É–º)</p>
            <ol style="margin-left: 20px; margin-top: 10px;">
              <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–¢–∞—Ä–∏—Ñ—ã"</li>
              <li>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –∑–≤—ë–∑–¥</li>
              <li>–û–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram Stars</li>
            </ol>
          </div>`;
        }

        fixActions.innerHTML = fixHtml;
      }

      result.innerHTML = html;
    }
  </script>
</body>
</html>
